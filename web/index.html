<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WaveCalling – Smoke Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .row { margin-bottom: 12px; }
    #log { border: 1px solid #ccc; padding: 8px; height: 220px; overflow: auto; background: #fafafa; }
    .ok { color: #0a7; } .err { color: #b00; }
    #artifacts a { display: block; margin: 2px 0; }
    progress { width: 100%; height: 16px; }
  </style>
</head>
<body>
  <h1>WaveCalling – quick run</h1>

  <form id="runForm" enctype="multipart/form-data">
    <div class="row">
      <input type="file" id="files" name="files" multiple required />
    </div>
    <div class="row">
      <label><input type="checkbox" id="verbose" /> verbose</label>
    </div>
    <div class="row">
      <button type="submit" id="startBtn">Start run</button>
    </div>
  </form>

  <div class="row">
    <progress id="progress" value="0" max="1"></progress>
    <div id="status">Idle</div>
  </div>

  <div id="log"></div>

  <h3>Artifacts</h3>
  <div id="artifacts">(will appear at DONE)</div>

  <script>
    const form = document.getElementById('runForm');
    const filesInput = document.getElementById('files');
    const verboseInput = document.getElementById('verbose');
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');
    const logEl = document.getElementById('log');
    const artifactsEl = document.getElementById('artifacts');

    let es = null;

    function log(msg, cls='') {
      const p = document.createElement('div');
      if (cls) p.className = cls;
      p.textContent = msg;
      logEl.appendChild(p);
      logEl.scrollTop = logEl.scrollHeight;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();                      // IMPORTANT: don’t full-submit the form
      if (!filesInput.files.length) {
        alert('Pick at least one file'); return;
      }
      startBtn.disabled = true;
      statusEl.textContent = 'Uploading file(s)...';
      progressEl.value = 0;
      logEl.textContent = '';
      artifactsEl.textContent = '';

      try {
        const fd = new FormData();
        for (const f of filesInput.files) fd.append('files', f, f.name);
        fd.append('verbose', verboseInput.checked ? 'true' : 'false');

        const resp = await fetch('/api/runs', { method: 'POST', body: fd });
        if (!resp.ok) throw new Error(`POST /api/runs failed: ${resp.status}`);
        const data = await resp.json();
        const runId = data.run_id;
        statusEl.textContent = `Run started: ${runId}`;
        log(`run_id=${runId}`, 'ok');

        // open SSE
        if (es) { es.close(); es = null; }
        es = new EventSource(`/api/runs/${runId}/events`);
        es.onmessage = async (ev) => {
          try {
            const evt = JSON.parse(ev.data);
            statusEl.textContent = `${evt.phase}: ${evt.message || ''}`;
            if (typeof evt.progress === 'number') progressEl.value = Math.min(Math.max(evt.progress, 0), 1);
            log(`[${evt.phase}] ${evt.message || ''}`);

            if (evt.phase === "WRITE_PARTIAL" && evt.extra) {
                const p1 = evt.extra.tracks_partial;
                const p2 = evt.extra.waves_partial;
                log(`Partial: <a href="${p1}" target="_blank">metrics.partial.csv</a>, ` +
                    `<a href="${p2}" target="_blank">metrics_waves.partial.csv</a>`);
                document.getElementById("partialLinks").innerHTML =
                    `<a href="${p1}" target="_blank">metrics.partial.csv</a> · ` +
                    `<a href="${p2}" target="_blank">metrics_waves.partial.csv</a>`;
                }
            if (evt.phase === "WRITE" && evt.extra) {
            const { tracks_csv, waves_csv, overlay_json, manifest_json } = evt.extra;
            document.getElementById("finalLinks").innerHTML =
                `<a href="${tracks_csv}" target="_blank">metrics.csv</a> · ` +
                `<a href="${waves_csv}" target="_blank">metrics_waves.csv</a> · ` +
                `<a href="${overlay_json}" target="_blank">overlay</a> · ` +
                `<a href="${manifest_json}" target="_blank">manifest.json</a>`;
            }

            if (evt.phase === 'DONE') {
              es.close();
              // fetch artifact URLs and render them
              const meta = await (await fetch(`/api/runs/${runId}`)).json();
              const a = meta.artifacts;
              artifactsEl.innerHTML = '';
              for (const [k, v] of Object.entries(a)) {
                const link = document.createElement('a');
                link.href = v; link.target = '_blank';
                link.textContent = k + ' → ' + v;
                artifactsEl.appendChild(link);
              }
              startBtn.disabled = false;
            }
            if (evt.phase === 'ERROR') {
              es.close();
              startBtn.disabled = false;
              log('Pipeline error: ' + (evt.message || 'unknown'), 'err');
            }
          } catch (err) {
            log('Bad event payload: ' + err, 'err');
          }
        };
        es.onerror = (e) => {
          log('SSE error (connection dropped?)', 'err');
        };
      } catch (err) {
        startBtn.disabled = false;
        statusEl.textContent = 'Error during upload';
        log(String(err), 'err');
      }
    });
  </script>
  <div id="partialLinks"></div>
  <div id="finalLinks"></div>
</body>
</html>
